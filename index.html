<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>Batch Planner 批次規劃器</title>
  <style>
    *{box-sizing:border-box;font-family:system-ui,sans-serif}
    body{margin:0;padding:2rem;background:#f5f6fa}
    h1{margin-top:0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}
    .card{background:#fff;padding:1.2rem 1.5rem;border-radius:1rem;box-shadow:0 4px 18px rgba(0,0,0,.07)}
    label{display:block;margin-top:.75rem;margin-bottom:.25rem;font-weight:600}
    select,input[type="number"],input[type="text"]{width:100%;padding:.5rem .6rem;border:1px solid #cfd2dc;border-radius:.5rem;font-size:1rem}
    button{padding:.45rem 1rem;border:none;border-radius:.55rem;font-size:1rem;font-weight:600;cursor:pointer;transition:background .2s ease}
    button.primary{background:#007aff;color:#fff}
    button.danger{background:#ff3b30;color:#fff}
    button.secondary{background:#555;color:#fff}
    button:disabled{background:#9bc2ff;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.45rem .4rem;text-align:left;border-bottom:1px solid #e2e4ea;font-size:.95rem}
    th{background:#fafafa;font-weight:700}
    .batch-title{margin:.75rem 0 .25rem;font-weight:700}
  </style>
</head>
<body>
  <h1>Batch Planner 批次規劃器</h1>

  <div class="grid">
    <!-- 輸入卡片 -->
    <div class="card">
      <h2>新增品項</h2>
      <label for="category">類別</label>
      <select id="category" required>
        <option value="" selected disabled>請選擇</option>
        <option value="drug">藥品</option>
        <option value="supplement">保健品</option>
        <option value="quasi">醫藥部外品</option>
      </select>

      <label for="name">商品名稱</label>
      <input id="product_name" type="text" placeholder="例如 A1" required />

      <label for="qty">數量 (盒/罐)</label>
      <input id="qty" type="number" min="1" step="1" placeholder="僅輸入數字" required />

      <button id="addBtn" class="primary" style="margin-top:1rem;width:100%">加入列表</button>

      <!-- 新增備註 -->
      <div style="margin-top:1rem;font-size:0.9rem;color:#555;">
        <strong>備註：</strong>
        <ul style="margin:0;padding-left:1.5rem;">
          <li>「WAKAMOTO 若元錠 / わかもと」是藥品</li>
          <li>「朝日 ASAHI 愛表斯錠 Ebios エビオス錠」是藥品</li>
        </ul>
      </div>

    </div>

    <!-- 列表卡片 -->
    <div class="card" style="grid-column:span 2">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>目前輸入的品項</h2>
        <button id="exportItems" class="secondary">匯出列表 CSV</button>
      </div>
      <table id="itemTable">
        <thead>
          <tr><th>#</th><th>類別</th><th>名稱</th><th>數量</th><th>操作</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 分批結果 -->
  <div class="card" style="margin-top:2rem">
   <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>分批結果</h2>
        <button id="exportBatches" class="secondary">匯出分批 CSV</button> 
   </div>
    <div id="batchResult">尚未輸入品項</div>
  </div>

<script>
// ---------------- 規則常數 ----------------
const CATEGORY_LABEL = {drug:"藥品", supplement:"保健品", quasi:"醫藥部外品"};
const SKU_LIMIT = {drug:2, supplement:12, quasi:10};
const DRUG_SKU_PER_BATCH = 6;
const BATCH_TOTAL_LIMIT = 48;

// ---------------- 狀態 ----------------
const items = [];
let currentBatches = [];

// ---------------- DOM ----------------
const elCat  = document.getElementById("category");
const elName = document.getElementById("product_name");
const elQty  = document.getElementById("qty");
const addBtn = document.getElementById("addBtn");
const tbody  = document.querySelector("#itemTable tbody");
const batchDiv = document.getElementById("batchResult");
const btnExportItems = document.getElementById("exportItems");
const btnExportBatches = document.getElementById("exportBatches");

// ---------------- 新增品項 ----------------
addBtn.addEventListener("click", () => {
  const cat = elCat.value;
  const name = elName.value.trim();
  const qty = parseInt(elQty.value, 10);
  if(!cat||!name||!qty||qty<1){alert("請確認所有欄位皆正確");return;}
  items.push({category:cat,name,qty});
  renderItemTable();
  computeAndRenderBatches();
  elCat.value="";elName.value="";elQty.value="";
});

// ---------------- 刪除功能 ----------------
tbody.addEventListener("click", e=>{
  if(e.target.matches("button[data-index]")){
    const idx=parseInt(e.target.dataset.index,10);
    if(!isNaN(idx)){
      items.splice(idx,1);
      renderItemTable();
      computeAndRenderBatches();
    }
  }
});

// ---------------- 匯出 CSV ----------------
btnExportItems.addEventListener("click", ()=>{
  if(items.length===0){alert("列表為空");return;}
  const rows=[["類別","名稱","數量"],...items.map(it=>[CATEGORY_LABEL[it.category],it.name,it.qty])];
  downloadCSV("items.csv",rows);
});

btnExportBatches.addEventListener("click", ()=>{
  if(currentBatches.length===0){alert("尚未計算分批");return;}
  const rows=[["Batch","類別","名稱","數量"]];
  currentBatches.forEach((b,idx)=>{
    b.items.forEach(it=>{
      rows.push([`Batch #${idx+1}`,CATEGORY_LABEL[it.category],it.name,it.qty]);
    });
  });
  downloadCSV("batches.csv",rows);
});

function downloadCSV(filename,rows){
  const csvBody = rows.map(r=>r.map(s=>`"${s}"`).join(",")).join("\n");
  const csvContent = "\uFEFF" + csvBody; // UTF‑8 BOM 防亂碼
  const blob = new Blob([csvContent],{type:"text/csv;charset=utf-8;"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  URL.revokeObjectURL(link.href);
}

// ---------------- UI Render ----------------
function renderItemTable(){
  tbody.innerHTML = items.map((it,i)=>
    `<tr><td>${i+1}</td><td>${CATEGORY_LABEL[it.category]}</td><td>${it.name}</td><td>${it.qty}</td><td><button class="danger" data-index="${i}">刪除</button></td></tr>`
  ).join("");
}

function computeAndRenderBatches(){
  if(items.length===0){batchDiv.textContent="尚未輸入品項";currentBatches=[];return;}
  currentBatches = splitIntoBatches(items);
  let html="";
  currentBatches.forEach((b,idx)=>{
    html+=`<div class="batch-title">Batch #${idx+1} (共 ${b.totalUnits} 盒)</div><table><thead><tr><th>類別</th><th>名稱</th><th>數量</th></tr></thead><tbody>`;
    b.items.forEach(it=>{html+=`<tr><td>${CATEGORY_LABEL[it.category]}</td><td>${it.name}</td><td>${it.qty}</td></tr>`;});
    html+=`</tbody></table>`;
  });
  batchDiv.innerHTML=html;
}

// ---------------- 切批演算法 ----------------
function splitIntoBatches(src){
  const queue=src.map(o=>({...o}));
  const batches=[];
  class Batch{
    constructor(){this.items=[];this.totalUnits=0;this.drugSkuSet=new Set();}
    existingQty(c,n){const f=this.items.find(x=>x.category===c&&x.name===n);return f?f.qty:0;}
    canAdd(c,n,a){if(this.existingQty(c,n)+a>SKU_LIMIT[c])return false;if(c==="drug"&&!this.drugSkuSet.has(n)&&this.drugSkuSet.size>=DRUG_SKU_PER_BATCH)return false;if(this.totalUnits+a>BATCH_TOTAL_LIMIT)return false;return true;}
    add(c,n,a){const f=this.items.find(x=>x.category===c&&x.name===n);f?f.qty+=a:this.items.push({category:c,name:n,qty:a});if(c==="drug")this.drugSkuSet.add(n);this.totalUnits+=a;}
  }
  queue.forEach(it=>{
    let rem=it.qty;const per=SKU_LIMIT[it.category];
    while(rem>0){let chunk=Math.min(rem,per);let placed=false;
      for(const b of batches){const allowed=Math.min(per-b.existingQty(it.category,it.name),BATCH_TOTAL_LIMIT-b.totalUnits,chunk);if(allowed>0&&b.canAdd(it.category,it.name,allowed)){b.add(it.category,it.name,allowed);rem-=allowed;placed=true;break;}}
      if(!placed){const b=new Batch();const amt=Math.min(per,rem,BATCH_TOTAL_LIMIT);b.add(it.category,it.name,amt);batches.push(b);rem-=amt;}
    }
  });
  return batches;
}
</script>
</body>
</html>
